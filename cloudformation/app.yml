AWSTemplateFormatVersion: '2010-09-09'
Description: ResilienceHub Application
Parameters:
  StackIrland:
    Description: Arn for StackIrland
    Type: String
  StackFrankfurt:
    Description: Arn for StackFrankfurt
    Type: String
  RestApiIrland:
    Description: ID for RestApiIrland
    Type: String
  RestApiFrankfurt:
    Description: ID for RestApiFrankfurt
    Type: String
  HealthcheckFunctionIrland:
    Description: ID for HealthcheckIrland
    Type: String
  HealthcheckFunctionFrankfurt:
    Description: ID for HealthcheckFrankfurt
    Type: String
  DynamoFunctionIrland:
    Description: ID for DynamocheckIrland
    Type: String
  DynamoFunctionFrankfurt:
    Description: ID for DynamoFrankfurt
    Type: String
  DeadletterTopicIrland:
    Description: ID for DeadletterTopicIrland
    Type: String
  DeadletterTopicFrankfurt:
    Description: ID for DeadletterTopicFrankfurt
    Type: String
  AlarmTopicIrland:
    Description: ID for AlarmTopicIrland
    Type: String
  AlarmTopicFrankfurt:
    Description: ID for AlarmTopicFrankfurt
    Type: String
  DynamoGlobalTableName:
    Description: ID for DynamoGlobalTableName
    Type: String
    Default: 'dynamodbglobaltable'
Resources:
  AppPolicy:
    Type: AWS::ResilienceHub::ResiliencyPolicy
    Properties:
      DataLocationConstraint: AnyLocation
      Policy:
        Software:
          RpoInSecs: 300
          RtoInSecs: 1800
        Hardware:
          RpoInSecs: 0
          RtoInSecs: 0
        AZ:
          RpoInSecs: 0
          RtoInSecs: 0
        Region:
          RpoInSecs: 300
          RtoInSecs: 900
      PolicyDescription: "Global Mission Critical"
      PolicyName: GlobalMissionCritical
      Tier: MissionCritical
  Application:
    Type: AWS::ResilienceHub::App
    Properties:
      AppAssessmentSchedule: Daily
      AppTemplateBody: !Sub '{"resources":[{"logicalResourceId":{"identifier":"${HealthcheckFunctionFrankfurt}","logicalStackName":"StackFrankfurt","resourceGroupName":null},"type":"AWS::Lambda::Function","name":"healthcheckfunction-1"},{"logicalResourceId":{"identifier":"${RestApiFrankfurt}","logicalStackName":"StackFrankfurt","resourceGroupName":null},"type":"AWS::ApiGateway::RestApi","name":"apigatewayrestapi-1"},{"logicalResourceId":{"identifier":"${RestApiIrland}","logicalStackName":"StackIrland","resourceGroupName":null},"type":"AWS::ApiGateway::RestApi","name":"apigatewayrestapi"},{"logicalResourceId":{"identifier":"${HealthcheckFunctionIrland}","logicalStackName":"StackIrland","resourceGroupName":null},"type":"AWS::Lambda::Function","name":"healthcheckfunction"},{"logicalResourceId":{"identifier":"${DynamoFunctionFrankfurt}","logicalStackName":"StackFrankfurt","resourceGroupName":null},"type":"AWS::Lambda::Function","name":"dynamodbfunction-1"},{"logicalResourceId":{"identifier":"${AlarmTopicIrland}","logicalStackName":"StackIrland","resourceGroupName":null},"type":"AWS::SNS::Topic","name":"alarmtopic"},{"logicalResourceId":{"identifier":"${DeadletterTopicIrland}","logicalStackName":"StackIrland","resourceGroupName":null},"type":"AWS::SNS::Topic","name":"deadlettertopic"},{"logicalResourceId":{"identifier":"${DeadletterTopicFrankfurt}","logicalStackName":"StackFrankfurt","resourceGroupName":null},"type":"AWS::SNS::Topic","name":"deadlettertopic-1"},{"logicalResourceId":{"identifier":"${DynamoGlobalTableName}","logicalStackName":"StackIrland","resourceGroupName":null},"type":"AWS::DynamoDB::GlobalTable","name":"dynamodbglobaltable"},{"logicalResourceId":{"identifier":"${DynamoFunctionIrland}","logicalStackName":"StackIrland","resourceGroupName":null},"type":"AWS::Lambda::Function","name":"dynamodbfunction"},{"logicalResourceId":{"identifier":"${AlarmTopicFrankfurt}","logicalStackName":"StackFrankfurt","resourceGroupName":null},"type":"AWS::SNS::Topic","name":"alarmtopic-1"}],"appComponents":[{"id":"appcommon","name":"appcommon","type":"AWS::ResilienceHub::AppCommonAppComponent","resourceNames":[]},{"id":"ComputeAppComponent-ApiGatewayRestApi-RestApi","name":"ApiGatewayRestApi-RestApi","type":"AWS::ResilienceHub::ComputeAppComponent","resourceNames":["apigatewayrestapi","apigatewayrestapi-1"]},{"id":"ComputeAppComponent-LambdaFunction-Lambda","name":"LambdaFunction-Lambda-Healthcheck","type":"AWS::ResilienceHub::ComputeAppComponent","resourceNames":["healthcheckfunction","healthcheckfunction-1"]},{"id":"ComputeAppComponent-LambdaFunction-LambdaDynamo","name":"LambdaFunction-Dynamo","type":"AWS::ResilienceHub::ComputeAppComponent","resourceNames":["dynamodbfunction","dynamodbfunction-1"]},{"id":"NotificationAppComponent-SNSTopic-AlarmTopic","name":"SNSTopic-AlarmTopic","type":"AWS::ResilienceHub::NotificationAppComponent","resourceNames":["alarmtopic","alarmtopic-1"]},{"id":"NotificationAppComponent-SNSTopic-DeadLetterTopic","name":"SNSTopic-DeadLetterTopic","type":"AWS::ResilienceHub::NotificationAppComponent","resourceNames":["deadlettertopic","deadlettertopic-1"]},{"id":"DatabaseAppComponent-DynamoDBTable-GlobalTable","name":"DatabaseAppComponent-DynamoDBTable-GlobalTable","type":"AWS::ResilienceHub::DatabaseAppComponent","resourceNames":["dynamodbglobaltable"]}],"excludedResources":{"logicalResourceIds":[]},"version":2.0}'
      Description: lambda-vpc
      Name: lambda-vpc
      ResiliencyPolicyArn: !Ref 'AppPolicy'
      ResourceMappings:
        - LogicalStackName: 'StackIrland'
          MappingType: CfnStack
          PhysicalResourceId:
            Identifier: !Ref 'StackIrland'
            Type: Arn
            Region: eu-west-1
            AwsAccountId: !Ref "AWS::AccountId"
        - LogicalStackName: 'StackFrankfurt'
          MappingType: CfnStack
          PhysicalResourceId:
            Identifier: !Ref 'StackFrankfurt'
            Type: Arn
            Region: eu-central-1
            AwsAccountId: !Ref "AWS::AccountId"
Metadata: {}
Outputs:
  Application:
    Value: !Ref Application
